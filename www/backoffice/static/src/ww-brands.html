<link rel="import" href="imports.html"> 

<dom-module id="ww-brands">
    <style is="custom-style"> 
        paper-toolbar.card {
            --paper-toolbar-background: #ffffff;
            --paper-toolbar-title: { 
            font-weight: bold;
        }
        paper-button.green {
            background-color: var(--paper-green-500);
            --paper-button-ink-color: #31f0ef;
            color:white;
        }
    </style>
    <template>
        <firebase-query
            id = "query"
            app-name="[[config.databaseAppName]]"
            path="/brands"
            data="{{brands}}"
        ></firebase-query>

        <paper-card style="margin: 18px;">
            <paper-toolbar class="custom card">
                <span class="title">Brands</span>
                <paper-menu-button id = "menu" horizontalAlign="right" >
                    <paper-icon-button id="loginMenu" src="[[config.ic_more]]" class="dropdown-trigger"></paper-icon-button>
                    <paper-menu class="dropdown-content">
                        <paper-item   on-tap="_listTap" >List</paper-item> 
                    </paper-menu>
                </paper-menu-button>
            </paper-toolbar>
            <div  style="padding: 18px;">
                <div id="sheet">
                    <paper-input id="name" label="Name" required auto-validate error-message="Brands has a name."></paper-input>
                    <paper-input id="url"  label="Logo" required auto-validate error-message="Logo"></paper-input>
                                
                    <label for="uploadBrandLogo">Logo select here:</label> 
                    <input type="file" accept="image/*" value="upload" id="fileUpload" on-change="_upload"/> 

                </div>
                <div id="controls">
                    <paper-button   raised class="custom green" on-tap="_onAdd" >Add</paper-button>
                </div>
            </div>
        </paper-card>


        <paper-dialog id="listDialog" style="width:90%; margin: 100px">
            <h1>List</h1>
            <paper-dialog-scrollable> 
                    <paper-listbox>
                        <template is="dom-repeat" items="[[brands]]" as="brand"> 
                            <paper-item>
                               [[brand.id]] | [[brand.name]] | [[brand.logo]]
                            </paper-item>
                        </template> 
                    <paper-listbox>
            </paper-dialog-scrollable>
            <div class="buttons">
                <paper-button dialog-confirm autofocus>Close</paper-button>
            </div>
        </paper-dialog>
    </template>

    <script>
        Polymer({
            is: 'ww-brands', 

            properties: {  
                config: {
                    type: Object
                },
                file: {
                    type: Object
                }
            },

            _onAdd: function() {
                this.$.query.ref.push(
                    {
                        id: this._guid(),
                        name: this.$.name.value,
                        url: this.$.url.value,
                    }
                );
                this.$.name.value = null;
                this.$.url.value = null;
            },

            _s4 : function () {
                return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
            },

            _guid: function () { 
            return this._s4() + this._s4() + '-' + this._s4() + this._s4() + '-' +
                this._s4() + this._s4()  + '-' +this._s4()  + this._s4();
            },

            _listTap: function() {
                this.$.menu.close();
                this.$.listDialog.open();
            },

            _upload: function(e) {
                var metadata = {
                    contentType: 'image/png;image/jpeg;image/jpg;image/svg+xml',
                };

                //Get image
                this.file = e.target.files[0];

                //create a storage reference
                var storage = firebase.storage();
                var storageRef = storage.ref();
                var storageChildRef = storageRef.child('brands/' + this.file.name);

                //store the image
                var uploadTask = storageChildRef.put(this.file, metadata);
                uploadTask.catch(function(error){
                    switch (error.code) {
                    case 'storage/object_not_found':
                        console.info("storage/object_not_found");
                        break;
                    case 'storage/unauthorized':
                        console.info("storage/unauthorized");
                        break;
                    case 'storage/canceled':
                        console.info("storage/canceled");
                        break;
                    case 'storage/unknown':
                        console.info("storage/unknown");
                        break;
                    } 
                });
            }
        })
    </script>
</dom-module>
